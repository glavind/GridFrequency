---
title: "Grid Frequency Analysis"
author: "Michael Glavind Bülow Pedersen"
output: pdf_document
---

# Research Objectives

1. Download data from an API and a Web server.
2. Store and handle a large dataset ($`r format(365*24*60*60+1,scientific=FALSE,big.mark = ",")`$ observations per year).
3. Handle timeseries data that cross daylight savings.
4. Create beautiful, informative graphs.
5. Craft a piece of reproducable research.
6. Make a shiny/rStudio presentation showing the results.
7. Answer research questions:
    + is the European power grid frequency exactly 50 Hz on average?
    + what differences in grid frequency quality can be observed between the Nordic and Continental electricity grids?
    + how many occurences of extreme events occur?
    

# Introduction

The European electricity grid consists of several distinct frequency areas. One frequency area is the Nordic grid which covers Norway, Finland, Sweden and Eastern Denmark. Another frequency area is the Continental grid which covers countries such as Germany, France, Spain, Portugal, Italy, Slovenia, Czech Republic, Switzerland, Slovkia, Poland, and all the way to the border of Turkey...

To keep a power grid stable, it is necessary for the grid frequency to move within a narrow band around a predetermind value. 
For the European grid the frequency has been fixed at a reference frequency of 50 Hz+-1mHz. Whenever the frequency moves below this level, Transmission System Operators have contracted grid connected market participants to supply power to the grid at seconds notice. Similarly, if the frequency moves above 50 Hz TSO's have contracted participants to withdraw power from the grid. 
In the Continental grid extreme events are characterized by frequencies +- 100 mHz. Especially the low frequencies bound is critical because below -100 mHz all primary reserves have been exhausted and the grid cannot cope with additional loss off generation. Below -150 mHz there is a serious risk of power plants dropping out, because of the low frequency. 
On the other hand, at +200 mHz solar panels are also at risk of dropping out potentially leading to volatile situations..

It has been agreed to run the power system at exactly 50 Hz on average. Because accumulated short-term frequency deviations can move the average above 50 Hz on one day, it is necessary to correct the grid frequency by setting a lower reference frequency point on subsequent days. This should be observable as effects in the daily average frequency measurements.
Because of this correction, it should be possible to set a watch by measuring the grid frequency (give or take about a minute). 
We will test whether this correction does indeed occur.

# Getting the data

This sections get nitty gritty on how to retrieve frequency data. For the continent it is rather easy, because the french tso RTE provides this data in nicely formatted csv-files. For the Nordic grid however, we have to retrieve data from an undocumented api at the Norwegian tso Statnett. This requires some probing and error correction in the code.

If data sources and data retrieval is not of interest, you may proceed to the actual analysis. We end up with two dataset for the first nine months of 2015. 
For the Continental grid we have an observation for each 10 seconds leading to $`r format(as.double(difftime(as.POSIXct("2015-09-01"), as.POSIXct("2015-01-01"), units="sec"))/10,scientific=FALSE,big.mark = ",")`$ observations. 
For the Nordic grid we have an observations each second leading to $`r format(as.double(difftime(as.POSIXct("2015-09-01"), as.POSIXct("2015-01-01"), units="sec")),scientific=FALSE,big.mark = ",")`$ observations.


### Nordic

We can query the API of the [Norwegian TSO Statnett](http://www.statnett.no/en/Market-and-operations/) to get 1 second measurements ($`r format(365*24*60*60,scientific=FALSE,big.mark = ",")`$ observations per year).

The call to the API is http://driftsdata.statnett.no/restapi/Frequency/BySecond?FromInTicks=FromTimeInMs&ToInTicks=ToTimeInMs. This GET request returns 1 second measurements as well as startDate and EndDate of the request in Local timezone. The inputs are in ms since epoch and therefore UTC.

Data retrieval is somewhat complicated by the fact that the return data do not have datetimes associated with each observation. This becomes a problem because there are missing observations, which are just excluded from the returned list. This happens for instance on 2015-01-07 15:33:00 to 15:34:00, where only 39 observations are returned. To get a complete dataset we are therefore forced to download an hour, check if it is complete. If not, get each minute and check if complete. If not, get each second and check if complete or finally NA.
This process is time consuming (one GET request for one hour takes appr. 0.3-0.5 sec.), especially when we have to loop across each minute and second. To get a full year the approximate runtime is on the order of several hours.

The current implementation sometimes result in duplicate observations being added to the data frame. I cannot figure out where duplication occurs, so for now duplicate values are just excluded afterwards using the unique() function. 

The API can only return 1 hour of data (probably `r 60*60` observations). So,
```{r eval=F}
fromDate <- ymd_hms("2015-10-19 07:00:00")
toDate <- ymd_hms("2015-10-19 08:00:00")
```
gives data from "2015-10-19 09:00:00" to "2015-10-19 09:59:59"

**API Examples**

The following examples illustrates how Daylight Savings Time (DST) affects output.

Before DST:
```{r eval=F}
fromDate <- dmy_hms("28-03-2015 12:00:00")
toDate <- dmy_hms("28-03-2015 13:00:00")
```
> "2015-03-28 13:00:00"  
> "2015-03-28 13:59:59"

After DST:
```{r eval=F}
fromDate <- dmy_hms("29-03-2015 12:00:00")
toDate <- dmy_hms("29-03-2015 13:00:00")
```
> "2015-03-29 14:00:00"  
> "2015-03-29 14:59:59"

Under DST (02:00-03:00 local time / 01:00-02:00 UTC does not exist):
```{r eval=F}
fromDate <- dmy_hms("29-03-2015 00:00:00")
toDate <- dmy_hms("29-03-2015 01:00:00")
```
> "2015-03-29 01:00:00"  
> "2015-03-29 01:59:59"

```{r eval=F}
fromDate <- dmy_hms("29-03-2015 00:30:00")
toDate <- dmy_hms("29-03-2015 01:30:00")
```
> "2015-03-29 01:30:00"  
> "2015-03-29 03:29:59"

```{r eval=F}
fromDate <- dmy_hms("29-03-2015 01:00:00")
toDate <- dmy_hms("29-03-2015 02:00:00")
```
> "2015-03-29 03:00:00"  
> "2015-03-29 03:59:59"


### Continental

We can query the Website of the [French TSO RTE](http://clients.rte-france.com/lang/an/clients_producteurs/vie/vie_frequence.jsp) to get 10 second measurements ($`r format(365*24*60*60/10,scientific=FALSE,big.mark = ",")`$ observations per year).

The data returned is a zip file containing one csv file with 10 second measurements for one month in Hz. The format of the date is local time (Europe/Paris), with NA for hour 3 (02:00:00-02:59:50) in spring DST and presumably removal of hour 3 at the autumn DST.

# Analysis

